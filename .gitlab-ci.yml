variables:
  DEPLOY_USER: sh3292
  DEPLOY_URL: tux.cs.drexel.edu
  DEPLOY_PATH: ~/public_html/
  S3_BUCKET_NAME: saffat-bucket

stages:
  - generate-source
  - build
  - deploy

generate-sources:
  stage: generate-source
  image: python:3.8
  script:
    - pip install -r src/requirements.txt
    - python src/main.py resume
    - python src/main.py resume-simple
  artifacts:
    paths:
      - dist/

generate-resumes:
  stage: build
  image: blang/latex:ubuntu
  script:
    - cp resources/mcdowellcv.cls dist
    - cd dist
    - lualatex resume.tex
    - lualatex resume-simple.tex
  artifacts:
    paths:
      - dist/resume.pdf
      - dist/resume-simple.pdf
  dependencies:
    - generate-sources

deploy-to-tux:
  stage: deploy
  only:
    refs:
      - master
  script:
    - apt-get update -qq && apt-get install -y -qq sshpass
    - sshpass -e scp -o stricthostkeychecking=no dist/*.pdf $DEPLOY_USER@$DEPLOY_URL:$DEPLOY_PATH

deploy-to-s3:
  stage: deploy
  only:
    refs:
      - master
  image: python:latest
  script:
    - pip install awscli
    - aws s3 cp ./dist s3://$S3_BUCKET_NAME/ --recursive --exclude "*" --include "*.pdf"
